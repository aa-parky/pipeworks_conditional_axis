graph TB
    %% ============================================================
    %% LAYERED ARCHITECTURE WITH STATE BOUNDARIES
    %% Shows the vertical layers and horizontal pure/stateful zones
    %% ============================================================

    subgraph Layer5["<b>LAYER 5: USER DOMAIN</b>"]
        Player["ğŸ‘¤ <b>PLAYER</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Human actor experiencing<br/>the world"]
    end

    subgraph Layer4["<b>LAYER 4: PRESENTATION (Narrative Singularity)</b>"]
        UI["ğŸ­ <b>The Daily Undertaking UI</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/><b>STATEFUL & ADAPTIVE</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Presents world experience<br/>âœ“ Gossips across all layers<br/>âœ“ Maintains player session<br/>âœ“ Composes narrative<br/><br/><i>The only component allowed<br/>to break layer discipline</i>"]
    end

    subgraph Layer3["<b>LAYER 3: RUNTIME & VISUALIZATION</b>"]
        MUD["ğŸŒ <b>MUD Server</b><br/>(Interactive Runtime)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/><b>STATEFUL & ADAPTIVE</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Runs living world<br/>âœ“ Manages sessions<br/>âœ“ Evolves state over time<br/>âœ“ Processes player actions<br/><br/><i>Where determinism ends</i>"]

        ImageGen["ğŸ¨ <b>Image Generator</b><br/>(Visualisation Layer)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/><b>STATELESS & PURE</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Translates state to imagery<br/>âœ“ Deterministic rendering<br/>âœ“ No world knowledge<br/><br/><i>Pure transformation</i>"]
    end

    subgraph Layer2["<b>LAYER 2: GENERATION (Pure Transformation)</b>"]
        Generator["âš™ï¸ <b>Entity State Generator</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/><b>STATELESS & PURE</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Produces state snapshots<br/>âœ“ Applies axes + weights<br/>âœ“ Enforces exclusions<br/>âœ“ Deterministic (seeded)<br/><br/><i>Pure function:<br/>ID + config â†’ entity state</i>"]
    end

    subgraph Layer1["<b>LAYER 1: IDENTITY & MEMORY (Foundation)</b>"]
        Registry["ğŸ“‹ <b>Artefact Registry</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/><b>STATELESS (Immutable)</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Records existence<br/>âœ“ Provides stable identity<br/>âœ“ Remembers history<br/>âœ“ No simulation logic<br/><br/><i>What exists,<br/>what is missing</i>"]
    end

    %% ============================================================
    %% DATA FLOWS (Layer-to-Layer)
    %% ============================================================

    %% Player â†” UI (Entry point for all interaction)
    Player <-->|"<b>INTERACTIVE</b><br/>Actions / Experience"| UI

    %% UI â†” MUD (Bidirectional sync)
    UI <-->|"<b>BIDIRECTIONAL</b><br/>Player actions â†“<br/>Game state + narrative â†‘"| MUD

    %% MUD â†’ Image Gen (Visualization requests)
    MUD -->|"<b>TRANSFORMATION REQUEST</b><br/>Entity state + context"| ImageGen

    %% Image Gen â†’ UI (Visual assets)
    ImageGen -->|"<b>VISUAL ASSETS</b><br/>Images + metadata"| UI

    %% Generator â†’ MUD (State injection)
    Generator -->|"<b>STATE SNAPSHOT</b><br/>Entity state<br/>(conditions, quirks, metadata)"| MUD

    %% Registry â†’ Generator (Identity provision)
    Registry -->|"<b>IDENTITY + METADATA</b><br/>Artefact ID + kind + context"| Generator

    %% ============================================================
    %% STATE BOUNDARY ANNOTATIONS (Horizontal zones)
    %% ============================================================

    StatefulZone["<b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b><br/><b>STATEFUL ZONE</b><br/>Interactive, Adaptive, Evolving<br/><b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b>"]

    PureZone["<b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b><br/><b>PURE ZONE</b><br/>Deterministic, Reproducible, Stateless<br/><b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b>"]

    %% Position annotations to the side
    StatefulZone -.->|"Applies to"| MUD
    StatefulZone -.->|"Applies to"| UI
    PureZone -.->|"Applies to"| Generator
    PureZone -.->|"Applies to"| ImageGen
    PureZone -.->|"Applies to"| Registry

    %% ============================================================
    %% STYLING
    %% ============================================================

    classDef userLayer fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#000
    classDef singularityLayer fill:#ff6b6b,stroke:#c92a2a,stroke-width:4px,color:#fff,font-weight:bold
    classDef runtimeLayer fill:#748ffc,stroke:#4c6ef5,stroke-width:2px,color:#fff
    classDef generationLayer fill:#ffd43b,stroke:#fab005,stroke-width:2px,color:#000
    classDef identityLayer fill:#a0a0a0,stroke:#5c5c5c,stroke-width:2px,color:#fff
    classDef annotation fill:#e9ecef,stroke:#adb5bd,stroke-width:1px,color:#000,stroke-dasharray: 5 5

    class Player userLayer
    class UI singularityLayer
    class MUD,ImageGen runtimeLayer
    class Generator generationLayer
    class Registry identityLayer
    class StatefulZone,PureZone annotation
